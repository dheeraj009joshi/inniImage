{% extends "base.html" %}

{% block title %}Personal Information - {{ study.title }}{% endblock %}

{% block content %}

<div class="personal-info-container">
    <div class="personal-info-header">
        <h1 class="personal-info-title">Personal Information</h1>
        <p class="personal-info-subtitle">Please provide some basic information about yourself to help with our research</p>
    </div>

    <form method="POST" action="{{ url_for('study_participation.submit_personal_info', share_token=study.share_token) }}" class="personal-info-form">
        <!-- CSRF token added via JavaScript -->
        
        <div class="question-section">
            <h3 class="question-title">What is your age?</h3>
            <div class="question-options-grid">
                <div class="option-grid-item" onclick="selectOption(this, 'age', '18-24')" data-question-id="age" data-option-value="18-24">
                    <span class="option-label">18-24 years</span>
                </div>
                <div class="option-grid-item" onclick="selectOption(this, 'age', '25-34')" data-question-id="age" data-option-value="25-34">
                    <span class="option-label">25-34 years</span>
                </div>
                <div class="option-grid-item" onclick="selectOption(this, 'age', '35-44')" data-question-id="age" data-option-value="35-44">
                    <span class="option-label">35-44 years</span>
                </div>
                <div class="option-grid-item" onclick="selectOption(this, 'age', '45-54')" data-question-id="age" data-option-value="45-54">
                    <span class="option-label">45-54 years</span>
                </div>
                <div class="option-grid-item" onclick="selectOption(this, 'age', '55-64')" data-question-id="age" data-option-value="55-64">
                    <span class="option-label">55-64 years</span>
                </div>
                <div class="option-grid-item" onclick="selectOption(this, 'age', '65+')" data-question-id="age" data-option-value="65+">
                    <span class="option-label">65+ years</span>
                </div>
            </div>
        </div>

        <div class="question-section">
            <h3 class="question-title">What is your gender?</h3>
            <div class="question-options-grid">
                <div class="option-grid-item" onclick="selectOption(this, 'gender', 'male')" data-question-id="gender" data-option-value="male">
                    <span class="option-label">Male</span>
                </div>
                <div class="option-grid-item" onclick="selectOption(this, 'gender', 'female')" data-question-id="gender" data-option-value="female">
                    <span class="option-label">Female</span>
                </div>
                <div class="option-grid-item" onclick="selectOption(this, 'gender', 'non-binary')" data-question-id="gender" data-option-value="non-binary">
                    <span class="option-label">Non-binary</span>
                </div>
                <div class="option-grid-item" onclick="selectOption(this, 'gender', 'prefer-not-to-say')" data-question-id="gender" data-option-value="prefer-not-to-say">
                    <span class="option-label">Prefer not to say</span>
                </div>
            </div>
        </div>



        <div class="personal-info-actions">
            <a href="{{ url_for('study_participation.study_welcome', share_token=study.share_token) }}" class="btn btn--secondary">
                <span class="btn-icon">⬅️</span>
                Previous
            </a>
            <button type="submit" class="btn btn--primary btn-large">
                <span class="btn-icon">➡️</span>
                Next
            </button>
        </div>
    </form>
</div>

<script>
function selectOption(optionItem, questionName, optionValue) {
    // Remove selected class from all options in this question
    const questionSection = optionItem.closest('.question-section');
    questionSection.querySelectorAll('.option-grid-item').forEach(item => {
        item.classList.remove('selected');
        item.removeAttribute('data-selected');
    });
    
    // Add selected class to clicked option
    optionItem.classList.add('selected');
    
    // Store the selection in the option item for form submission
    optionItem.setAttribute('data-selected', 'true');
}

// Handle form submission
document.querySelector('.personal-info-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Check if all required fields are filled
    const requiredFields = ['age', 'gender'];
    const missingFields = [];
    
    requiredFields.forEach(field => {
        const selectedOption = form.querySelector(`[data-question-id="${field}"][data-selected="true"]`);
        if (!selectedOption) {
            missingFields.push(field);
        }
    });
    
    if (missingFields.length > 0) {
        alert('Please fill in all required fields: ' + missingFields.join(', '));
        return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="btn-icon">⏳</span> Submitting...';
    
    try {
        // Collect data from selected options
        const formData = new FormData();
        const selectedOptions = form.querySelectorAll('[data-selected="true"]');
        
        selectedOptions.forEach(option => {
            const questionId = option.getAttribute('data-question-id');
            const optionValue = option.getAttribute('data-option-value');
            formData.append(questionId, optionValue);
        });
        
        // Add CSRF token
        formData.append('csrf_token', '{{ csrf_token() }}');
        
        // Submit form data
        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Redirect to classification questions
            window.location.href = data.redirect_url;
        } else {
            throw new Error(data.error || 'Failed to submit personal info');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error submitting personal info: ' + error.message);
        
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});
</script>
{% endblock %}
