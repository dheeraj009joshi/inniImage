{% extends "base.html" %}

{% block title %}Classification Questions - Step 2b{% endblock %}

{% block content %}
<div class="study-creation-container">
    <!-- Progress Bar -->
    <div class="step-progress">
        <ul class="step-progress-list">
            <li class="step-progress-item step-progress-item--completed">
                <div class="step-progress-circle">1a</div>
                <span class="step-progress-label">Basic Details</span>
            </li>
            <li class="step-progress-item step-progress-item--completed">
                <div class="step-progress-circle">1b</div>
                <span class="step-progress-label">Study Type</span>
            </li>
            <li class="step-progress-item step-progress-item--completed">
                <div class="step-progress-circle">1c</div>
                <span class="step-progress-label">Rating Scale</span>
            </li>
            <li class="step-progress-item step-progress-item--completed">
                <div class="step-progress-circle">2a</div>
                <span class="step-progress-label">Elements</span>
            </li>
            <li class="step-progress-item step-progress-item--active">
                <div class="step-progress-circle">2b</div>
                <span class="step-progress-label">Questions</span>
            </li>
            <li class="step-progress-item">
                <div class="step-progress-circle">2c</div>
                <span class="step-progress-label">IPED Parameters</span>
            </li>
            <li class="step-progress-item">
                <div class="step-progress-circle">3a</div>
                <span class="step-progress-label">Generate Tasks</span>
            </li>
            <li class="step-progress-item">
                <div class="step-progress-circle">3b</div>
                <span class="step-progress-label">Launch</span>
            </li>
        </ul>
    </div>

    <div class="step-content">
        <div class="step-header">
            <h1 class="step-title">Step 2b: Classification Questions</h1>
            <p class="step-description">Add demographic and classification questions to segment your respondents</p>
        </div>

        <form method="POST" class="step-form" data-validate="true" data-loading="true">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="study-form-group">
                    <h3 class="section-title">Classification Questions</h3>
                    <p class="form-help">Add demographic and classification questions to segment your respondents. These questions will be asked before the main study tasks.</p>
                </div>
                
                <div class="study-form-group">
                    <label for="numQuestions" class="study-form-label">Number of Questions:</label>
                    <div class="study-form-row">
                        <input type="number" id="numQuestions" name="num_questions" value="{{ num_questions }}" min="0" max="10" class="study-form-control" onchange="updateQuestions()">
                        <button type="button" class="btn btn--outline" onclick="addQuestion()">➕ Add Question</button>
                    </div>
                </div>
                
                <div class="questions-container" id="questionsContainer">
                    {% for i in range(num_questions) %}
                    <div class="question-item" data-question-index="{{ i }}">
                        <div class="question-info">
                            <div class="question-icon">{{ i + 1 }}</div>
                            <div class="question-details">
                                <h4>Question {{ i + 1 }}</h4>
                                <button type="button" class="btn btn--danger btn--sm" onclick="removeQuestion({{ i }})">Remove</button>
                            </div>
                        </div>
                        
                        <div class="study-form-group">
                            <label class="study-form-label study-form-label--required">Question Text</label>
                            <input type="text" name="question_{{ i }}_text" class="study-form-control" placeholder="e.g., What is your age group?" required 
                                   value="{{ questions_data[i].question_text if questions_data and questions_data[i] else '' }}">
                        </div>
                        
                        <div class="study-form-row">
                            <div class="study-form-group">
                                <label class="study-form-label study-form-label--required">Question Type</label>
                                <select name="question_{{ i }}_type" class="study-form-control study-form-select" onchange="toggleAnswerOptions({{ i }}, this.value)" required>
                                    <option value="">Select type</option>
                                    <option value="single_choice" {% if questions_data and questions_data[i] and questions_data[i].question_type == 'single_choice' %}selected{% endif %}>Single Choice</option>
                                    <option value="multiple_choice" {% if questions_data and questions_data[i] and questions_data[i].question_type == 'multiple_choice' %}selected{% endif %}>Multiple Choice</option>
                                    <option value="text" {% if questions_data and questions_data[i] and questions_data[i].question_type == 'text' %}selected{% endif %}>Text Input</option>
                                    <option value="number" {% if questions_data and questions_data[i] and questions_data[i].question_type == 'number' %}selected{% endif %}>Number Input</option>
                                    <option value="date" {% if questions_data and questions_data[i] and questions_data[i].question_type == 'date' %}selected{% endif %}>Date</option>
                                </select>
                            </div>
                            
                            <div class="study-form-group">
                                <label class="study-form-label">Required</label>
                                <div class="form-checkbox">
                                    <input type="checkbox" name="question_{{ i }}_required" id="required_{{ i }}" 
                                           {% if questions_data and questions_data[i] and questions_data[i].is_required %}checked{% else %}checked{% endif %}>
                                    <label for="required_{{ i }}">This question is required</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="answer-options" id="answerOptions{{ i }}" style="display: {% if questions_data and questions_data[i] and questions_data[i].question_type in ['single_choice', 'multiple_choice'] %}block{% else %}none{% endif %};">
                            <label class="study-form-label">Answer Options</label>
                            <textarea name="question_{{ i }}_options" class="study-form-control study-form-textarea" rows="3" placeholder="Enter each option on a new line&#10;e.g.,&#10;18-24 years&#10;25-34 years&#10;35-44 years&#10;45+ years">{{ questions_data[i].answer_options|join('\n') if questions_data and questions_data[i] and questions_data[i].answer_options else '' }}</textarea>
                            <small class="form-help">Enter each option on a separate line</small>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="study-form-group">
                        <button type="button" class="btn btn--outline" onclick="addQuestion()">➕ Add Another Question</button>
                    </div>
                </div>
                
                <div class="step-actions">
                    <a href="{{ url_for('study_creation.step2a') }}" class="btn btn--secondary step-nav-btn">← Previous</a>
                    <button type="submit" class="btn btn--primary step-nav-btn">Continue to IPED Parameters →</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentQuestionCount = {{ num_questions }};

function toggleAnswerOptions(questionIndex, questionType) {
    const optionsDiv = document.getElementById(`answerOptions${questionIndex}`);
    
    if (questionType === 'single_choice' || questionType === 'multiple_choice') {
        optionsDiv.style.display = 'block';
        optionsDiv.querySelector('textarea').required = true;
    } else {
        optionsDiv.style.display = 'none';
        optionsDiv.querySelector('textarea').required = false;
    }
}

function addQuestion() {
    const container = document.getElementById('questionsContainer');
    const newQuestion = document.createElement('div');
    newQuestion.className = 'question-item';
    newQuestion.setAttribute('data-question-index', currentQuestionCount);
    
    newQuestion.innerHTML = `
        <div class="question-info">
            <div class="question-icon">${currentQuestionCount + 1}</div>
            <div class="question-details">
                <h4>Question ${currentQuestionCount + 1}</h4>
                <button type="button" class="btn btn--danger btn--sm" onclick="removeQuestion(${currentQuestionCount})">Remove</button>
            </div>
        </div>
        
        <div class="study-form-group">
            <label class="study-form-label study-form-label--required">Question Text</label>
            <input type="text" name="question_${currentQuestionCount}_text" class="study-form-control" placeholder="e.g., What is your age group?" required>
        </div>
        
        <div class="study-form-row">
            <div class="study-form-group">
                <label class="study-form-label study-form-label--required">Question Type</label>
                <select name="question_${currentQuestionCount}_type" class="study-form-control study-form-select" onchange="toggleAnswerOptions(${currentQuestionCount}, this.value)" required>
                    <option value="">Select type</option>
                    <option value="single_choice">Single Choice</option>
                    <option value="multiple_choice">Multiple Choice</option>
                    <option value="text">Text Input</option>
                    <option value="number">Number Input</option>
                    <option value="date">Date</option>
                </select>
            </div>
            
            <div class="study-form-group">
                <label class="study-form-label">Required</label>
                <div class="form-checkbox">
                    <input type="checkbox" name="question_${currentQuestionCount}_required" id="required_${currentQuestionCount}" checked>
                    <label for="required_${currentQuestionCount}">This question is required</label>
                </div>
            </div>
        </div>
        
        <div class="answer-options" id="answerOptions${currentQuestionCount}" style="display: none;">
            <label class="study-form-label">Answer Options</label>
            <textarea name="question_${currentQuestionCount}_options" class="study-form-control study-form-textarea" rows="3" placeholder="Enter each option on a new line&#10;e.g.,&#10;18-24 years&#10;25-34 years&#10;35-44 years&#10;45+ years"></textarea>
            <small class="form-help">Enter each option on a separate line</small>
        </div>
    `;
    
    container.appendChild(newQuestion);
    currentQuestionCount++;
    
    // Update the num_questions input
    document.getElementById('numQuestions').value = currentQuestionCount;
}

function removeQuestion(questionIndex) {
    const question = document.querySelector(`[data-question-index="${questionIndex}"]`);
    if (question) {
        question.remove();
        // Renumber remaining questions
        const questions = document.querySelectorAll('.question-item');
        questions.forEach((q, index) => {
            q.setAttribute('data-question-index', index);
            q.querySelector('h4').textContent = `Question ${index + 1}`;
            q.querySelector('.btn--danger').setAttribute('onclick', `removeQuestion(${index})`);
            
            // Update question icon
            const questionIcon = q.querySelector('.question-icon');
            if (questionIcon) questionIcon.textContent = index + 1;
            
            // Update form field names
            const textInput = q.querySelector('input[name^="question_"][name$="_text"]');
            const typeSelect = q.querySelector('select[name^="question_"][name$="_type"]');
            const requiredCheckbox = q.querySelector('input[name^="question_"][name$="_required"]');
            const optionsTextarea = q.querySelector('textarea[name^="question_"][name$="_options"]');
            const optionsDiv = q.querySelector('.answer-options');
            
            if (textInput) textInput.name = `question_${index}_text`;
            if (typeSelect) {
                typeSelect.name = `question_${index}_type`;
                typeSelect.setAttribute('onchange', `toggleAnswerOptions(${index}, this.value)`);
            }
            if (requiredCheckbox) {
                requiredCheckbox.name = `question_${index}_required`;
                requiredCheckbox.id = `required_${index}`;
                q.querySelector(`label[for^="required_"]`).setAttribute('for', `required_${index}`);
            }
            if (optionsTextarea) optionsTextarea.name = `question_${index}_options`;
            if (optionsDiv) optionsDiv.id = `answerOptions${index}`;
        });
        currentQuestionCount = questions.length;
        
        // Update the num_questions input
        document.getElementById('numQuestions').value = currentQuestionCount;
    }
}

function updateQuestions() {
    const numQuestions = parseInt(document.getElementById('numQuestions').value) || 0;
    const container = document.getElementById('questionsContainer');
    const currentQuestions = container.querySelectorAll('.question-item');
    
    if (numQuestions > currentQuestions.length) {
        // Add more questions
        for (let i = currentQuestions.length; i < numQuestions; i++) {
            addQuestion();
        }
    } else if (numQuestions < currentQuestions.length) {
        // Remove excess questions
        for (let i = currentQuestions.length - 1; i >= numQuestions; i--) {
            removeQuestion(i);
        }
    }
}

// Initialize answer options for existing questions
document.addEventListener('DOMContentLoaded', function() {
    const questions = document.querySelectorAll('.question-item');
    questions.forEach((question, index) => {
        const typeSelect = question.querySelector('select[name^="question_"][name$="_type"]');
        if (typeSelect && typeSelect.value) {
            toggleAnswerOptions(index, typeSelect.value);
        }
    });
});
</script>
{% endblock %}
