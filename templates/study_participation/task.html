{% extends "base.html" %}

{% block title %}{{ study.title }} - Task {{ task_number }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/study_participation.css') }}">
{% endblock %}

{% block content %}
<div class="study-participation-container">
    <div class="progress-indicator">
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (task_number / total_tasks) * 100 }}%"></div>
        </div>
        <div class="progress-text">{{ task_number }}/{{ total_tasks }}</div>
    </div>
    
    <div class="task-section">
        <div class="task-content">
            {% if current_task.orientation_text %}
            <div class="orientation-text">
                <p>{{ current_task.orientation_text }}</p>
            </div>
            {% endif %}
            
            {% if current_task.main_question %}
            <div class="main-question">
                <p>{{ current_task.main_question }}</p>
            </div>
            {% endif %}
            
            <div class="task-elements">
                <div class="elements-grid">
                    {% if current_task and current_task.elements_shown %}
                        {% for element_name, element_data in current_task.elements_shown.items() %}
                            {% if element_name.endswith('_content') and element_data and element_data != '' %}
                                {% set base_name = element_name.replace('_content', '') %}
                                {% set element_active = current_task.elements_shown.get(base_name, 0) %}
                                {% if element_active == 1 %}
                                    <div class="element-item">
                                        <img src="{{ element_data }}" alt="Element" class="task-element-img">
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            
            <div class="rating-section">
                <h3>How well do ALL OF THESE elements match what you're looking for?</h3>
                <div class="rating-instructions">
                    <p><strong>1 = Not really what I care about</strong></p>
                    <p><strong>9 = Feels exactly right for me</strong></p>
                </div>
                
                <div class="rating-grid">
                    {% for rating in range(1, 10) %}
                    <div class="rating-option" data-rating="{{ rating }}">
                        <div class="rating-label">
                            <span class="rating-number">{{ rating }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Task page loaded:', {{ task_number }}, 'of', {{ total_tasks }});
    
    // Task timing - record start time
    const taskStartTime = new Date();
    console.log('Task start time:', taskStartTime);
    
    // Rating selection and auto-advancement
    const ratingOptions = document.querySelectorAll('.rating-option');
    let selectedRating = null;
    let isRatingSubmitted = false;
    
    ratingOptions.forEach(option => {
        const rating = option.dataset.rating;
        const label = option.querySelector('.rating-label');
        
        // Click on rating option
        option.addEventListener('click', function() {
            if (isRatingSubmitted) return; // Prevent multiple submissions
            
            console.log('Rating selected:', rating);
            selectedRating = parseInt(rating);
            
            // Remove active class from all rating options
            ratingOptions.forEach(opt => opt.querySelector('.rating-label').classList.remove('active'));
            
            // Add active class to selected rating
            label.classList.add('active');
            
            // Lock the rating (disable further clicks)
            isRatingSubmitted = true;
            ratingOptions.forEach(opt => opt.style.pointerEvents = 'none');
            
            // Calculate task duration
            const taskEndTime = new Date();
            const taskDurationSeconds = (taskEndTime - taskStartTime) / 1000;
            console.log('Task duration:', taskDurationSeconds, 'seconds');
            
            // Store rating and timing in session
            const taskData = {
                task_number: {{ task_number }},
                rating: selectedRating,
                timestamp: taskEndTime.toISOString(),
                task_start_time: taskStartTime.toISOString(),
                task_end_time: taskEndTime.toISOString(),
                task_duration_seconds: taskDurationSeconds,
                task_data: {{ current_task|tojson|safe }}
            };
            
            // Send task data to server
            fetch(`/study/{{ study._id }}/task-complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Task data stored successfully');
                } else {
                    console.error('Error storing task data:', data.error);
                }
            })
            .catch(error => {
                console.error('Error sending task data:', error);
            });
            
            // Show loading state
            label.innerHTML = '<span class="rating-number">âœ“</span>';
            label.style.background = 'var(--participation-success)';
            label.style.color = 'white';
            
            // Auto-advance to next task after short delay
            setTimeout(() => {
                const currentTask = {{ task_number }};
                const totalTasks = {{ total_tasks }};
                
                if (currentTask < totalTasks) {
                    // Go to next task
                    window.location.href = `/study/{{ study._id }}/task/${currentTask + 1}`;
                } else {
                    // All tasks completed, go to completion page
                    window.location.href = `/study/{{ study._id }}/completed`;
                }
            }, 1000);
        });
        
        // Hover effects for rating options
        label.addEventListener('mouseenter', function() {
            if (!isRatingSubmitted && !this.classList.contains('active')) {
                this.classList.add('hover');
            }
        });
        
        label.addEventListener('mouseleave', function() {
            this.classList.remove('hover');
        });
    });
    
    // Add smooth transitions for elements
    const elementItems = document.querySelectorAll('.element-item');
    elementItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.5s ease-out';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, 200 + (index * 100));
    });
});
</script>
{% endblock %}
